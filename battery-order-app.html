<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="old-fashioned.css" />
    <link async rel="icon" type="image/x-icon" href="old-fashioned.png">
    <script src="old-fashioned.js"></script>
    <script src="old-fashioned-forms.js"></script>
    <script src="old-fashioned-convenience.js"></script>
    <script>
        window.onload = () => {

            const sceneManager = new SceneManager();
            const model = new Model();
            const orderController = new Controller(model);
            orderController.onSubmission = (o) => {
                confirmationScreen.add(new TextArea(JSON.stringify(o, null, 2)), Position.CENTER).add(new Label('Confirmation', FontSize.LARGE), Position.NORTH);
                sceneManager.routeTo('confirmation');
            };
            orderController.onSearchTermEntered = (term) =>
                fetch('http://127.0.0.1:8080/test-order.json')
                    .then(response => response.json())
                    .then(data => {
                        sceneManager.routeTo('order');
                        orderController.onModelUpdate(data);
                    });


            const searchScene = sceneManager.createScene('search', 'Old Fashioned Search').add(
                new SubmissionForm(
                    'Search', (searchTerm) => orderController.onSearchTermEntered(searchTerm), 'Search Orders').addChildren(
                        new TextFormEntry('orderNumber', '', 'Order Number', new RegexValidator('Enter a 3-digit order number.', /[0-9]{3}/))
                    ).getComponent()
                , Position.CENTER);
            

            const orderScene = sceneManager.createScene('order', 'Old Fashioned Forms');
            const confirmationScreen = sceneManager.createScene('confirmation', 'Old Fashioned Confirmation');
            orderScene.onUpdate = (updatedOrder) => {
                orderScene.add(
                    new SubmissionForm('Order', (o) => orderController.onSubmission(o), 'Submit Order').addChildren(
                        new DateFormEntry('shipDate', updatedOrder.shipDate, 'Ship Date'),
                        ConvenientForms.ADDRESS_FORM_BUILDER(updatedOrder.address),
                        new FormEntryGroupArray('batteries', updatedOrder.batteries, 'Batteries',
                            (item, counter) => new FormEntryGroup('battery', {}, 'Battery ' + counter)
                                .addChildren(
                                    new DropdownListFormEntry('batteryModel', item.batteryModel, 'Battery Model', fetch('http://127.0.0.1:8080/battery-models.json')
                    .then(response => response.json()), StringValidators.NOT_EMPTY),
                                    new NumberFormEntry('quantity', item.quantity, 'Quantity', new Validator('Enter a number greater than 0', (val) => val < 1)),
                                    new TextFormEntry('cover', item.cover, 'Cover', new RegexValidator('Please enter Y or N', /^(?:Y\b|N\b)/))
                                ), 'Add Battery')
                    ).getComponent()
                    , Position.CENTER);
            }

            orderScene.add(new Label('Loading...', FontSize.LARGE), Position.CENTER);

            model.addObserver(orderScene);

            sceneManager.routeTo('search');
        };
    </script>
</head>

<body>
    <div id="glass"></div>
</body>

</html>